---
title: Using Rubocop
___

## Philosophy

Rubocop changes quite often. New cops are added, and configuration is changed, in just about every release. This ends up meaning that our ruby project end up conforming to various styles depending on which version of the rubocop gem they happen to be using.

We've also found that much of what is included in rubocop feels overly opinionated and prods us to make refactors that feel arbitrary and don't always lead to better or more readable code.

As such, our implementation of rubocop (meaning the combination of our rubocop configuration and in our jenkins configuration) does the following:

  1. Uses `DisabledByDefault: true`. We only check rules which we have explicitly opted in to.
  2. Distinguishes between two main kinds of style violations: those that should break a build, and others which we'd like to know about but are less critical.

### How to propse changes to the rules

  1. Make an edit to [the style guide](https://github.com/tedconf/code-style-guides/blob/master/linters/rubocop/rubocop.yml), and open a PR.
  2. Always specify a [severity](https://rubocop.readthedocs.io/en/latest/configuration/#severity). `warning` if you think violations should break a build, and `refactor` if not.

## Setup

See [the rubocop README](https://github.com/bbatsov/rubocop) for instructions
on installing the gem.

After this is done, add the following to your project's .rubocop.yml:

```yml
inherit_from:
  - https://raw.githubusercontent.com/tedconf/code-style-guides/master/linters/rubocop/rubocop.yml
  - .rubocop_todo.yml # if you have one
```

And in your project's .gitignore:

```
.rubocop-http*
```

This is important because rubocop will fetch our style guide & cache it locally.
(More info on that below.)

The [rubocop README](https://github.com/bbatsov/rubocop#inheriting-configuration-from-a-remote-url)
has more details on how the file is sourced & updated. Essentially, it will be
downloaded to your machine & used. rubocop has some rules about updating the
local copy when the remote file changes. You can also remove your local version
(which will be in a `./rubocop-http*` file) to force an update to the latest.

**NOTE:** Support for sourcing config from URLs was added in [rubocop 0.35.0](https://github.com/bbatsov/rubocop/releases/tag/v0.35.0)
In older versions you'll see `No such file or directory @ rb_sysopen` errors
when starting rubocop.

## Using Rubocop While Coding

In talkstar, I use guard to run rspec tests in the background while I'm coding.
I added the [guard-rubocop plugin](https://github.com/yujinakayama/guard-rubocop)
to also check for style every time a file is saved.

```ruby
guard :rubocop, cli: ['--display-cop-names'] do
  watch(%r{.+\.rb$})
  watch(%r{(?:.+/)?\.rubocop(_todo)?\.yml$}) { |m| File.dirname(m[0]) }
end
```
from [talkstar's Guardfile](https://github.com/tedconf/talkstar/blob/6b06cfe03ccce7775486632709c84847d9a272a3/Guardfile#L40-L43)

Again, notice `--display-cop-names` as well as automatically re-running checks
when `.rubocop_todo.yml` is changed. (That's particularly helpful when working
on reducing the backlog of violations.) The gem's README has more information on other options you might potentially be interested in.

## Rubocop and Jenkins

### Flow

  1. Run rubocop during every jenkins run.
    - report rubocop output in xml using the [rubocop-checkstyle_formatter gem](https://github.com/eitoball/rubocop-checkstyle_formatter).
    - Running rubocop should not break the build immediately, as that can prevent later steps in the build from running.
  2. use the [jenkins checkstyle plugin](https://wiki.jenkins.io/display/JENKINS/Checkstyle+Plugin) to consume the XML report generated by rubocop.
    - This builds graphs of number of violations at varying severities.
    - It also builds HTML reports on which code caused the violations.
    - Finally, the checkstyle plugin can fail the build if certain conditions are met. Failing at this stage will not prevent other necessary build actions from occurring.

### Understanding violation severities

Rubocop supports [several severity levels](https://rubocop.readthedocs.io/en/latest/configuration/#severity) including 'refactor', 'convention', 'warning', 'error' and 'fatal'.

The Jenkins checkstyle plugin understands 'high', 'normal', and 'low' severities.

Rubocop severities are mapped to checkstyle severities by [this code](https://github.com/eitoball/rubocop-checkstyle_formatter/blob/bed516d30c78f8e09f45d076f8a35484c9f5777d/lib/rubocop/formatter/checkstyle_formatter.rb#L54-L61)

Thus any rubocop violations of 'refactor' or 'convention' level will not break a build, while 'warning', 'error', or 'fatal' will.

## when to TODO and when to disable?

  1. Disabling means "rubocop is wrong here. This looks like a problem, but it isn't. There's nothing to fix here."
  2. Adding a TODO means "I don't have time/inclination to fix this now, but
  this is worth fixing someday."

Remember that violations of a severity less than `warning` will not break your jenkins build, so there's no need to get too hasty in disabling those checks.
